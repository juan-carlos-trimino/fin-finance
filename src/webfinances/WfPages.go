package webfinances

import (
  "github.com/juan-carlos-trimino/gplogger"
  "github.com/juan-carlos-trimino/gpmiddlewares"
  "github.com/juan-carlos-trimino/gpsessions"
  //Package template (html/template) implements data-driven templates for generating HTML output
  //safe against code injection. It provides the same interface as text/template and should be used
  //instead of text/template whenever the output is HTML.
  "html/template"
  "net/http"
)

var tmpl *template.Template

/***
In Go, the predefined init() function sets off a piece of code to run before any other part of the
package; i.e., adding the init() function tells the compiler that when the package is imported, it
should run the init() function once. Unlike the main() function that can only be declared once, the
init() function can be declared multiple times throughout a package.
***/
func init() {
  logger.LogInfo("Entering init/webfinances.", "-1")
  /***
  The Must function wraps around the ParseGlob function that returns a pointer to a template and an
  error, and it panics if the error is not nil.
  ***/
  tmpl = template.Must(template.ParseGlob("webfinances/templates/*.html"))
}

/***
When handling authentication errors, the application should not disclose which part of the
authentication data was incorrect. Instead of "Invalid username" or "Invalid password", just use
"Invalid username and/or password" interchangeably.
***/
func invalidSession(res http.ResponseWriter) {
  tmpl.ExecuteTemplate(res, "index_page", struct {
    Error string
  } { "Invalid username and/or password" })
}

type WfPages struct{}

func (p WfPages) IndexPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering IndexPage/webfinances.", "-1")
  tmpl.ExecuteTemplate(res, "index_page", nil)
}

func (p WfPages) LoginPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering LoginPage/webfinances.", "-1")
  un := req.PostFormValue("username")
  pw := req.PostFormValue("password")
  if !sessions.ValidateUser(un, pw) {
    invalidSession(res)
  } else {
    sessionToken, session := sessions.AddEntryToSessions(un)
    AddSessionDataPerUser(un)
    /***
    Once a cookie is set on a client, it is sent along with every subsequent request. Cookies store
    historical information (including user login information) on the client's computer. The
    client's browser sends these cookies everytime the user visits the same website, automatically
    completing the login step for the user.

    Sessions, on the other hand, store historical information on the server side. The server uses a
    session id to identify different sessions, and the session id that is generated by the server
    should always be random and unique. You can use cookies or URL arguments to get the client's
    identity.
    ***/
    http.SetCookie(res, &http.Cookie{
      Name: "session_token",
      Value: sessionToken,
      Expires: session.Expiry,
    })
    http.Redirect(res, req, "/welcome", http.StatusSeeOther)
  }
}

func (p WfPages) LogoutPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering LogoutPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    DeleteSessionDataPerUser(sessions.GetUserName(sessionToken))
    cookie := sessions.DeleteSession(sessionToken)
    http.SetCookie(res, cookie)
    http.Redirect(res, req, "/", http.StatusSeeOther)
  }
}

func (p WfPages) WelcomePage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering WelcomePage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "welcome_page", struct {
      Header string
      Datetime string
    } { "Investments", logger.DatetimeFormat() })
  }
}

func (p WfPages) ContactPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering ContactPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "contact_page", struct {
      Header string
      Datetime string
    } { "Investments", logger.DatetimeFormat() })
  }
}

func (p WfPages) AboutPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering AboutPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    /***
    Executing the template means that we take the content from the template files, combine it with
    data from another source, and generate the final HTML content.
    ***/
    tmpl.ExecuteTemplate(res, "about_page", struct {
      Header string
      Datetime string
    } { "Investments", logger.DatetimeFormat() })
  }
}

func (p WfPages) PublicHomeFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicHomeFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/css/home.css")
}

func (p WfPages) PublicGetParamsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicGetParamsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/getParams.js")
}

func (p WfPages) PublicMortgageFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicMortgageFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/mortgage.js")
}

func (p WfPages) PublicOaInterestRateFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaInterestRateFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaInterestRate.js")
}

func (p WfPages) PublicOaPresentValueFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaPresentValueFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaPresentValue.js")
}

func (p WfPages) PublicOaFutureValueFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaFutureValueFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaFutureValue.js")
}

func (p WfPages) PublicOaCompoundingPeriodsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaCompoundingPeriodsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaCompoundingPeriods.js")
}

func (p WfPages) PublicOaEqualPeriodicPaymentsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaEqualPeriodicPaymentsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaEqualPeriodicPayments.js")
}

func (p WfPages) PublicOaGrowingAnnuityFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaGrowingAnnuityFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaGrowingAnnuity.js")
}

func (p WfPages) PublicOaPerpetuityFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicOaPerpetuityFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/OaPerpetuity.js")
}

func (p WfPages) PublicAdCompoundingPeriodsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicAdCompoundingPeriodsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/AdCompoundingPeriods.js")
}

func (p WfPages) PublicAdEqualPeriodicPaymentsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicAdEqualPeriodicPaymentsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/AdEqualPeriodicPayments.js")
}

func (p WfPages) PublicAdFutureValueFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicAdFutureValueFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/AdFutureValue.js")
}

func (p WfPages) PublicAdPresentValueFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicAdPresentValueFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/AdPresentValue.js")
}

func (p WfPages) PublicBondsFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicBondsFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/bonds.js")
}

func (p WfPages) PublicBondsYTMFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicBondsYTMFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/bondsYTM.js")
}

func (p WfPages) PublicMiscellaneousFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicMiscellaneousFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/miscellaneous.js")
}

func (p WfPages) PublicSimpleInterestAccurateFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicSimpleInterestAccurateFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/SimpleInterestAccurate.js")
}

func (p WfPages) PublicSimpleInterestBankersFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicSimpleInterestBankersFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/SimpleInterestBankers.js")
}

func (p WfPages) PublicSimpleInterestOrdinaryFile(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering PublicSimpleInterestOrdinaryFile/webfinances.", "-1")
  http.ServeFile(res, req, "./webfinances/public/js/SimpleInterestOrdinary.js")
}

func (p WfPages) FinancesPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering FinancesPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "finances_page", struct {
      Header string
      Datetime string
    } { "Finances", logger.DatetimeFormat() })
  }
}

func (p WfPages) SimpleInterestPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering SimpleInterestPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "simple_interest_page", struct {
      Header string
      Datetime string
    } { "Simple Interest", logger.DatetimeFormat() })
  }
}

func (p WfPages) OrdinaryAnnuityPage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering OrdinaryAnnuityPage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "ordinary_annuity_page", struct {
      Header string
      Datetime string
    } { "Ordinary Annuity", logger.DatetimeFormat() })
  }
}

func (p WfPages) AnnuityDuePage(res http.ResponseWriter, req *http.Request) {
  logger.LogInfo("Entering AnnuityDuePage/webfinances.", "-1")
  ctxKey := middlewares.MwContextKey{}
  sessionToken, _ := ctxKey.GetSessionToken(req.Context())
  if sessionToken == "" {
    invalidSession(res)
  } else {
    tmpl.ExecuteTemplate(res, "annuity_due_page", struct {
      Header string
      Datetime string
    } { "Annuity Due", logger.DatetimeFormat() })
  }
}
